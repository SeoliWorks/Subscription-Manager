{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/info-gather/%E3%83%9F%E3%83%A5%E3%83%BC%E3%82%B8%E3%83%83%E3%82%AF/subscription-manager/db/schema.ts"],"sourcesContent":["import { pgTable, text, integer, boolean, timestamp, uuid, date, index } from 'drizzle-orm/pg-core';\nimport { type InferSelectModel, type InferInsertModel } from 'drizzle-orm';\nimport { SUBSCRIPTION_CYCLES, CURRENCIES } from '@/lib/constants';\n\nexport const subscriptions = pgTable('subscriptions', {\n  id: uuid('id').defaultRandom().primaryKey(),\n  userId: text('user_id').notNull(),\n  \n  name: text('name').notNull(),\n  // integerだが、通貨の最小単位(cents/yen)で保存する\n  price: integer('price').notNull(), \n  currency: text('currency').default(CURRENCIES.JPY.code).notNull(),\n  \n  cycle: text('cycle', { enum: [SUBSCRIPTION_CYCLES.monthly, SUBSCRIPTION_CYCLES.yearly] }).notNull(),\n  nextPayment: date('next_payment').notNull(),\n  \n  category: text('category').default('general'),\n  isActive: boolean('is_active').default(true).notNull(),\n  \n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(), \n}, (table) => {\n  return {\n    userIdIdx: index('user_id_idx').on(table.userId),\n  };\n});\n\nexport type Subscription = InferSelectModel<typeof subscriptions>;\nexport type NewSubscription = InferInsertModel<typeof subscriptions>;\n"],"names":[],"mappings":";;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;;;AAEO,MAAM,gBAAgB,IAAA,gKAAO,EAAC,iBAAiB;IACpD,IAAI,IAAA,uKAAI,EAAC,MAAM,aAAa,GAAG,UAAU;IACzC,QAAQ,IAAA,uKAAI,EAAC,WAAW,OAAO;IAE/B,MAAM,IAAA,uKAAI,EAAC,QAAQ,OAAO;IAC1B,oCAAoC;IACpC,OAAO,IAAA,6KAAO,EAAC,SAAS,OAAO;IAC/B,UAAU,IAAA,uKAAI,EAAC,YAAY,OAAO,CAAC,8HAAU,CAAC,GAAG,CAAC,IAAI,EAAE,OAAO;IAE/D,OAAO,IAAA,uKAAI,EAAC,SAAS;QAAE,MAAM;YAAC,uIAAmB,CAAC,OAAO;YAAE,uIAAmB,CAAC,MAAM;SAAC;IAAC,GAAG,OAAO;IACjG,aAAa,IAAA,uKAAI,EAAC,gBAAgB,OAAO;IAEzC,UAAU,IAAA,uKAAI,EAAC,YAAY,OAAO,CAAC;IACnC,UAAU,IAAA,6KAAO,EAAC,aAAa,OAAO,CAAC,MAAM,OAAO;IAEpD,WAAW,IAAA,iLAAS,EAAC,cAAc,UAAU,GAAG,OAAO;IACvD,WAAW,IAAA,iLAAS,EAAC,cAAc,UAAU,GAAG,OAAO;AACzD,GAAG,CAAC;IACF,OAAO;QACL,WAAW,IAAA,gKAAK,EAAC,eAAe,EAAE,CAAC,MAAM,MAAM;IACjD;AACF"}},
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///home/info-gather/%E3%83%9F%E3%83%A5%E3%83%BC%E3%82%B8%E3%83%83%E3%82%AF/subscription-manager/db/index.ts"],"sourcesContent":["import { drizzle } from 'drizzle-orm/postgres-js';\nimport postgres from 'postgres';\nimport * as schema from './schema';\n\nif (!process.env.DATABASE_URL) {\n  throw new Error('DATABASE_URL is not set in environment variables');\n}\n\nconst connectionString = process.env.DATABASE_URL;\n\nconst globalForDb = globalThis as unknown as {\n  conn: postgres.Sql | undefined;\n};\n\n// 環境変数 DB_MAX_CONNECTIONS があれば使い、なければデフォルト設定\nconst MAX_CONNECTIONS = process.env.DB_MAX_CONNECTIONS ? parseInt(process.env.DB_MAX_CONNECTIONS) : (process.env.NODE_ENV === 'production' ? 10 : 1);\n\nconst client = globalForDb.conn ?? postgres(connectionString, { \n  max: MAX_CONNECTIONS,\n});\n\nif (process.env.NODE_ENV !== 'production') {\n  globalForDb.conn = client;\n}\n\nexport const db = drizzle(client, { schema });\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,mBAAmB,QAAQ,GAAG,CAAC,YAAY;AAEjD,MAAM,cAAc;AAIpB,6CAA6C;AAC7C,MAAM,kBAAkB,QAAQ,GAAG,CAAC,kBAAkB,GAAG,SAAS,QAAQ,GAAG,CAAC,kBAAkB,IAAK,sCAAwC,0BAAK;AAElJ,MAAM,SAAS,YAAY,IAAI,IAAI,IAAA,mJAAQ,EAAC,kBAAkB;IAC5D,KAAK;AACP;AAEA,wCAA2C;IACzC,YAAY,IAAI,GAAG;AACrB;AAEO,MAAM,KAAK,IAAA,qKAAO,EAAC,QAAQ;IAAE,QAAA;AAAO"}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///home/info-gather/%E3%83%9F%E3%83%A5%E3%83%BC%E3%82%B8%E3%83%83%E3%82%AF/subscription-manager/lib/validations.ts"],"sourcesContent":["import { z } from 'zod';\nimport { SUBSCRIPTION_CYCLES, CURRENCIES } from '@/lib/constants';\n\nexport const formSchema = z.object({\n  name: z.string().min(1, 'サービス名は必須です'),\n  price: z.coerce.number()\n    .min(0.01, '金額を入力してください')\n    .nonnegative('マイナスの金額は入力できません'),\n  currency: z.enum([CURRENCIES.JPY.code, CURRENCIES.USD.code, CURRENCIES.EUR.code]),\n  cycle: z.enum([SUBSCRIPTION_CYCLES.monthly, SUBSCRIPTION_CYCLES.yearly], {\n    required_error: '支払いサイクルを選択してください',\n  }),\n  nextPayment: z.string().date().refine((val) => {\n    const date = new Date(val);\n    return !isNaN(date.getTime()) && date.getFullYear() > 2000;\n  }, '正しい日付を入力してください'),\n  category: z.string().optional(),\n});\n\nexport type FormValues = z.infer<typeof formSchema>;\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,MAAM,aAAa,kLAAC,CAAC,MAAM,CAAC;IACjC,MAAM,kLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACxB,OAAO,kLAAC,CAAC,MAAM,CAAC,MAAM,GACnB,GAAG,CAAC,MAAM,eACV,WAAW,CAAC;IACf,UAAU,kLAAC,CAAC,IAAI,CAAC;QAAC,8HAAU,CAAC,GAAG,CAAC,IAAI;QAAE,8HAAU,CAAC,GAAG,CAAC,IAAI;QAAE,8HAAU,CAAC,GAAG,CAAC,IAAI;KAAC;IAChF,OAAO,kLAAC,CAAC,IAAI,CAAC;QAAC,uIAAmB,CAAC,OAAO;QAAE,uIAAmB,CAAC,MAAM;KAAC,EAAE;QACvE,gBAAgB;IAClB;IACA,aAAa,kLAAC,CAAC,MAAM,GAAG,IAAI,GAAG,MAAM,CAAC,CAAC;QACrC,MAAM,OAAO,IAAI,KAAK;QACtB,OAAO,CAAC,MAAM,KAAK,OAAO,OAAO,KAAK,WAAW,KAAK;IACxD,GAAG;IACH,UAAU,kLAAC,CAAC,MAAM,GAAG,QAAQ;AAC/B"}},
    {"offset": {"line": 150, "column": 0}, "map": {"version":3,"sources":["file:///home/info-gather/%E3%83%9F%E3%83%A5%E3%83%BC%E3%82%B8%E3%83%83%E3%82%AF/subscription-manager/app/actions.ts"],"sourcesContent":["'use server';\n\nimport { db } from '@/db';\nimport { subscriptions } from '@/db/schema';\nimport { formSchema, type FormValues } from '@/lib/validations';\nimport { convertAmountToMinorUnits } from '@/lib/utils';\nimport { eq, desc, and } from 'drizzle-orm';\nimport { revalidatePath } from 'next/cache';\n\n// --- Auth Handling ---\n// 実運用の際はここをClerkやAuth.jsのロジックに置き換える\nasync function getCurrentUser() {\n  return { id: 'user_demo_123' };\n}\n// --------------------\n\nexport type ActionResponse<T = null> = {\n  success: boolean;\n  data?: T;\n  error?: string;\n  fieldErrors?: Record<string, string[]>; // Zodのフィールドエラー用\n};\n\n// フロントエンド公開用データ型\nexport type SubscriptionPublic = Omit<typeof subscriptions.$inferSelect, 'userId' | 'createdAt' | 'updatedAt'>;\n\nexport async function getSubscriptions(): Promise<ActionResponse<SubscriptionPublic[]>> {\n  try {\n    const user = await getCurrentUser();\n    \n    // 型安全性を確保しつつ、必要なカラムのみ取得\n    const data = await db.query.subscriptions.findMany({\n      where: eq(subscriptions.userId, user.id),\n      orderBy: [desc(subscriptions.nextPayment)],\n      columns: {\n        id: true,\n        name: true,\n        price: true,\n        currency: true,\n        cycle: true,\n        nextPayment: true,\n        category: true,\n        isActive: true,\n      }\n    });\n    return { success: true, data: data as SubscriptionPublic[] };\n  } catch (error) {\n    console.error('Failed to fetch subscriptions:', error);\n    return { success: false, error: 'データの取得に失敗しました', data: [] };\n  }\n}\n\nexport async function addSubscription(data: FormValues): Promise<ActionResponse> {\n  const validated = formSchema.safeParse(data);\n  if (!validated.success) {\n    return { \n      success: false, \n      error: '入力内容を確認してください',\n      fieldErrors: validated.error.flatten().fieldErrors \n    };\n  }\n\n  try {\n    const user = await getCurrentUser();\n    \n    // UIの数値(小数)をDB用整数に変換 (v1.1で修正済みの安全な関数を使用)\n    const priceInMinorUnits = convertAmountToMinorUnits(\n      validated.data.price, \n      validated.data.currency\n    );\n\n    await db.insert(subscriptions).values({\n      ...validated.data,\n      price: priceInMinorUnits,\n      userId: user.id,\n      updatedAt: new Date(),\n    });\n\n    // サーバー側でパスを固定してRevalidate\n    revalidatePath('/');\n    return { success: true };\n  } catch (error) {\n    console.error('[Action:addSubscription] Error:', error);\n    \n    if (error instanceof Error && error.message.includes('unique constraint')) {\n       return { success: false, error: '重複したデータが存在します' };\n    }\n\n    return { success: false, error: 'データベースへの保存に失敗しました' };\n  }\n}\n\nexport async function deleteSubscription(id: string): Promise<ActionResponse> {\n  try {\n    const user = await getCurrentUser();\n\n    // userIdを条件に含めることで、所有者のみが削除可能\n    const result = await db.delete(subscriptions)\n      .where(\n        and(\n          eq(subscriptions.id, id),\n          eq(subscriptions.userId, user.id)\n        )\n      )\n      .returning({ deletedId: subscriptions.id });\n\n    if (result.length === 0) {\n      return { success: false, error: '削除対象が見つからないか、権限がありません' };\n    }\n    \n    revalidatePath('/');\n    return { success: true };\n  } catch (error) {\n    console.error('[Action:deleteSubscription] Error:', error);\n    return { success: false, error: '削除処理中にエラーが発生しました' };\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;AAEA;AACA;AACA;AACA;AACA;AAAA;AACA;;;;;;;;;AAEA,wBAAwB;AACxB,oCAAoC;AACpC,eAAe;IACb,OAAO;QAAE,IAAI;IAAgB;AAC/B;AAaO,eAAe;IACpB,IAAI;QACF,MAAM,OAAO,MAAM;QAEnB,wBAAwB;QACxB,MAAM,OAAO,MAAM,iHAAE,CAAC,KAAK,CAAC,aAAa,CAAC,QAAQ,CAAC;YACjD,OAAO,IAAA,wKAAE,EAAC,6HAAa,CAAC,MAAM,EAAE,KAAK,EAAE;YACvC,SAAS;gBAAC,IAAA,sKAAI,EAAC,6HAAa,CAAC,WAAW;aAAE;YAC1C,SAAS;gBACP,IAAI;gBACJ,MAAM;gBACN,OAAO;gBACP,UAAU;gBACV,OAAO;gBACP,aAAa;gBACb,UAAU;gBACV,UAAU;YACZ;QACF;QACA,OAAO;YAAE,SAAS;YAAM,MAAM;QAA6B;IAC7D,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kCAAkC;QAChD,OAAO;YAAE,SAAS;YAAO,OAAO;YAAiB,MAAM,EAAE;QAAC;IAC5D;AACF;AAEO,eAAe,gBAAgB,IAAgB;IACpD,MAAM,YAAY,gIAAU,CAAC,SAAS,CAAC;IACvC,IAAI,CAAC,UAAU,OAAO,EAAE;QACtB,OAAO;YACL,SAAS;YACT,OAAO;YACP,aAAa,UAAU,KAAK,CAAC,OAAO,GAAG,WAAW;QACpD;IACF;IAEA,IAAI;QACF,MAAM,OAAO,MAAM;QAEnB,0CAA0C;QAC1C,MAAM,oBAAoB,IAAA,yIAAyB,EACjD,UAAU,IAAI,CAAC,KAAK,EACpB,UAAU,IAAI,CAAC,QAAQ;QAGzB,MAAM,iHAAE,CAAC,MAAM,CAAC,6HAAa,EAAE,MAAM,CAAC;YACpC,GAAG,UAAU,IAAI;YACjB,OAAO;YACP,QAAQ,KAAK,EAAE;YACf,WAAW,IAAI;QACjB;QAEA,0BAA0B;QAC1B,IAAA,+IAAc,EAAC;QACf,OAAO;YAAE,SAAS;QAAK;IACzB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QAEjD,IAAI,iBAAiB,SAAS,MAAM,OAAO,CAAC,QAAQ,CAAC,sBAAsB;YACxE,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAgB;QACnD;QAEA,OAAO;YAAE,SAAS;YAAO,OAAO;QAAoB;IACtD;AACF;AAEO,eAAe,mBAAmB,EAAU;IACjD,IAAI;QACF,MAAM,OAAO,MAAM;QAEnB,8BAA8B;QAC9B,MAAM,SAAS,MAAM,iHAAE,CAAC,MAAM,CAAC,6HAAa,EACzC,KAAK,CACJ,IAAA,yKAAG,EACD,IAAA,wKAAE,EAAC,6HAAa,CAAC,EAAE,EAAE,KACrB,IAAA,wKAAE,EAAC,6HAAa,CAAC,MAAM,EAAE,KAAK,EAAE,IAGnC,SAAS,CAAC;YAAE,WAAW,6HAAa,CAAC,EAAE;QAAC;QAE3C,IAAI,OAAO,MAAM,KAAK,GAAG;YACvB,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAwB;QAC1D;QAEA,IAAA,+IAAc,EAAC;QACf,OAAO;YAAE,SAAS;QAAK;IACzB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sCAAsC;QACpD,OAAO;YAAE,SAAS;YAAO,OAAO;QAAmB;IACrD;AACF;;;IA1FsB;IA0BA;IAwCA;;AAlEA,+OAAA;AA0BA,+OAAA;AAwCA,+OAAA"}},
    {"offset": {"line": 290, "column": 0}, "map": {"version":3,"sources":["file:///home/info-gather/%E3%83%9F%E3%83%A5%E3%83%BC%E3%82%B8%E3%83%83%E3%82%AF/subscription-manager/.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getSubscriptions as '007071a33524f4454576920418b491e0fab0e3e12b'} from 'ACTIONS_MODULE0'\nexport {addSubscription as '404e9a4ccf58df4817d4a0bb8eaa3a8e46e9e1f2d9'} from 'ACTIONS_MODULE0'\nexport {deleteSubscription as '4093a9c0faae4cfa98993e11e6dcb0010e4f2a4273'} from 'ACTIONS_MODULE0'\nexport {deleteSubscription as '4093a9c0faae4cfa98993e11e6dcb0010e4f2a4273'} from 'ACTIONS_MODULE0'\nexport {addSubscription as '404e9a4ccf58df4817d4a0bb8eaa3a8e46e9e1f2d9'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}